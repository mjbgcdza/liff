<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Rewards Admin - ระบบจัดการ</title>
    <meta name="description" content="admin Food Rewards" />
    <meta name="author" content="iton5" />
    <meta property="og:title" content="admin Food Rewards-iton5-thailand" />
    <meta property="og:description" content="admin Food Rewards" />
    <meta property="og:type" content="website" />
    <meta property="og:image" content="https://lh3.googleusercontent.com/d/1Ck_OCfEW4dEp3A1k9yfQplYmW7qmwzFF" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://bit.ly/fontiton5" type="text/css" charset="utf-8" />
    <style>
        :root {
            --primary: #1ea896;
            --secondary: #ff715b;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --white: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'line_seed_sans_th';
        }

        body {
            background-color: var(--light);
            color: var(--dark);
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 250px;
            background-color: var(--dark);
            color: var(--white);
            z-index: 1000;
            overflow-y: auto;
            transition: transform 0.3s ease;
        }

        .sidebar.collapsed {
            transform: translateX(-250px);
        }

        .sidebar-header {
            padding: 20px;
            background-color: var(--primary);
            text-align: center;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
        }

        .sidebar-menu li {
            border-bottom: 1px solid #495057;
        }

        .sidebar-menu a {
            display: block;
            padding: 15px 20px;
            color: var(--white);
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background-color: var(--primary);
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
        }

        .main-content {
            margin-left: 250px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        .topbar {
            background-color: var(--white);
            padding: 15px 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .topbar-left {
            display: flex;
            align-items: center;
        }

        .sidebar-toggle {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--dark);
            cursor: pointer;
            margin-right: 15px;
        }

        .content {
            padding: 20px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .card-body {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), #16a085);
            color: var(--white);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-card.secondary {
            background: linear-gradient(135deg, var(--secondary), #e74c3c);
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success), #27ae60);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning), #f39c12);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--white);
            font-size: 0.9rem;
        }

        .table th,
        .table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            height: 60px;
        }

        .table th {
            background-color: var(--light);
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }


        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 0.9rem;
            transition: background-color 0.3s;
            margin: 2px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: var(--white);
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--white);
        }

        .btn-success {
            background-color: var(--success);
            color: var(--white);
        }

        .btn-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .btn-info {
            background-color: var(--info);
            color: var(--white);
        }

        .btn-sm {
            padding: 4px 8px;
            font-size: 0.8rem;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 1.1rem;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(30, 168, 150, 0.2);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--white);
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #dee2e6;
            text-align: right;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background-color: var(--success);
            color: var(--white);
        }

        .badge-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .badge-warning {
            background-color: var(--warning);
            color: var(--dark);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: -10px;
        }

        .col {
            flex: 1;
            padding: 10px;
            min-width: 300px;
        }

        .col-6 {
            flex: 0 0 50%;
            padding: 10px;
            min-width: 300px;
        }

        .col-4 {
            flex: 0 0 33.333%;
            padding: 10px;
            min-width: 250px;
        }

        .col-3 {
            flex: 0 0 25%;
            padding: 10px;
            min-width: 200px;
        }

        .user-search-section {
            background-color: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .search-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-method {
            text-align: center;
            padding: 20px;
            background-color: var(--white);
            border-radius: 8px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-method:hover,
        .search-method.active {
            border-color: var(--primary);
            background-color: rgba(30, 168, 150, 0.1);
        }

        .search-method i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .qr-scanner {
            text-align: center;
            padding: 20px;
            border: 2px dashed var(--primary);
            border-radius: 8px;
            background-color: var(--white);
        }

        #qr-reader {
            width: 100%;
            max-width: 300px;
            margin: 0 auto;
        }

        .analytics-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .download-section {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .download-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .text-success {
            color: var(--success) !important;
        }

        .text-danger {
            color: var(--danger) !important;
        }

        .mobile-hidden {
            display: block;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-250px);
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }

            .row {
                flex-direction: column;
            }

            .col-6,
            .col-4,
            .col-3 {
                flex: 1;
                min-width: auto;
            }

            .col {
                min-width: auto;
            }

            .card-header {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .search-methods {
                grid-template-columns: 1fr;
            }

            .analytics-actions {
                justify-content: center;
            }

            .download-options {
                grid-template-columns: 1fr;
            }

            .table {
                font-size: 0.8rem;
            }

            .table th,
            .table td {
                padding: 8px 4px;
            }

            .mobile-hidden {
                display: none;
            }

            .chart-container {
                height: 250px;
            }

            .modal-content {
                width: 95%;
                margin: 10px;
            }
        }

        @media (max-width: 480px) {
            .content {
                padding: 10px;
            }

            .card-body {
                padding: 15px;
            }

            .btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .btn-lg {
                padding: 10px 20px;
                font-size: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            .chart-container {
                height: 200px;
            }
        }
    </style>
</head>

<body>
   
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h4>Food Rewards Admin</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="#" class="active" onclick="showPage('dashboard')"><i
                        class="fas fa-tachometer-alt"></i>Dashboard</a></li>
            <li><a href="#" onclick="showPage('users')"><i class="fas fa-users"></i>จัดการผู้ใช้</a></li>
            <li><a href="#" onclick="showPage('rewards')"><i class="fas fa-gift"></i>จัดการรางวัล</a></li>
            <li><a href="#" onclick="showPage('qrcodes')"><i class="fas fa-qrcode"></i>จัดการ QR Code</a></li>
            <li><a href="#" onclick="showPage('transactions')"><i class="fas fa-exchange-alt"></i>ประวัติรายการ</a></li>
            <li><a href="#" onclick="showPage('analytics')"><i class="fas fa-chart-bar"></i>วิเคราะห์ข้อมูล</a></li>

        </ul>
    </nav>

    
    <div class="main-content" id="mainContent">
        
        <div class="topbar">
            <div class="topbar-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h5 id="pageTitle">Dashboard</h5>
            </div>
            <div class="topbar-right">
                <span id="admin-username">ผู้ดูแลระบบ</span>
            </div>
        </div>

       
        <div class="content">
            
            <div id="dashboard" class="page active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">ผู้ใช้ทั้งหมด</div>
                    </div>
                    <div class="stat-card secondary">
                        <div class="stat-value" id="totalPoints">0</div>
                        <div class="stat-label">แต้มที่แจกทั้งหมด</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-value" id="totalRedemptions">0</div>
                        <div class="stat-label">การแลกรางวัล</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-value" id="activeQRCodes">0</div>
                        <div class="stat-label">QR Code ที่ใช้ได้</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>กราฟการเพิ่มแต้มรายวัน</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="pointsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>กราฟการแลกรางวัล</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="redemptionsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6>รายการล่าสุด</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ผู้ใช้</th>
                                        <th>รายการ</th>
                                        <th>แต้ม</th>
                                        <th class="mobile-hidden">วันที่</th>
                                    </tr>
                                </thead>
                                <tbody id="recentTransactions">
                                    <tr>
                                        <td colspan="4" class="loading">
                                            <div class="spinner"></div>
                                            กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

           
            <div id="users" class="page">
                
                <div class="user-search-section">
                    <h6 style="margin-bottom: 15px;"><i class="fas fa-search"></i> ค้นหาและเพิ่มแต้มให้ผู้ใช้</h6>

                    <div class="search-methods">
                        <div class="search-method active" onclick="switchSearchMethod('manual')">
                            <i class="fas fa-edit"></i>
                            <div><strong>ค้นหาด้วยตนเอง</strong></div>
                            <small>เลือกจากรายการผู้ใช้</small>
                        </div>
                        <div class="search-method" onclick="switchSearchMethod('qr')">
                            <i class="fas fa-qrcode"></i>
                            <div><strong>สแกน QR Code</strong></div>
                            <small>สแกนเพื่อค้นหาผู้ใช้</small>
                        </div>
                    </div>

                   
                    <div id="manualSearch" class="search-content">
                        <div class="form-group">
                            <label class="form-label">เลือกผู้ใช้</label>
                            <select class="form-control" id="selectedUserId">
                                <option value="">-- เลือกผู้ใช้ --</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="openAddPointsModal()">
                            <i class="fas fa-plus"></i> เพิ่มแต้ม
                        </button>
                    </div>

                   
                    <div id="qrSearch" class="search-content" style="display: none;">
                        <div class="qr-scanner">
                            <div id="qr-reader"></div>
                            <p style="margin: 15px 0;">สแกน QR Code ของสมาชิกเพื่อค้นหาและเพิ่มแต้ม</p>
                            <button class="btn btn-primary" onclick="startQRScanner()">
                                <i class="fas fa-camera"></i> เริ่มสแกน
                            </button>
                            <button class="btn btn-secondary" onclick="stopQRScanner()" style="display: none;"
                                id="stopScanBtn">
                                <i class="fas fa-stop"></i> หยุดสแกน
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h6>รายการผู้ใช้ทั้งหมด</h6>
                        <button class="btn btn-info" onclick="refreshUsers()">
                            <i class="fas fa-sync"></i> รีเฟรช
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ชื่อผู้ใช้</th>
                                        <th>แต้มสะสม</th>
                                        <th class="mobile-hidden">ระดับ</th>
                                        <th class="mobile-hidden">วันที่สมัคร</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTable">
                                    <tr>
                                        <td colspan="5" class="loading">
                                            <div class="spinner"></div>
                                            กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

          
            <div id="rewards" class="page">
                <div class="card">
                    <div class="card-header">
                        <h6>จัดการรางวัล</h6>
                        <button class="btn btn-primary" onclick="openRewardModal()">
                            <i class="fas fa-plus"></i> เพิ่มรางวัล
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ชื่อรางวัล</th>
                                        <th class="mobile-hidden">คำอธิบาย</th>
                                        <th>แต้มที่ต้องใช้</th>
                                        <th class="mobile-hidden">จำนวนคงเหลือ</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="rewardsTable">
                                    <tr>
                                        <td colspan="5" class="loading">
                                            <div class="spinner"></div>
                                            กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

           
            <div id="qrcodes" class="page">
                <div class="card">
                    <div class="card-header">
                        <h6>จัดการ QR Code</h6>
                        <button class="btn btn-primary" onclick="openQRModal()">
                            <i class="fas fa-plus"></i> สร้าง QR Code
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>โค้ด</th>
                                        <th>แต้ม</th>
                                        <th class="mobile-hidden">คำอธิบาย</th>
                                        <th class="mobile-hidden">หมดอายุ</th>
                                        <th>สถานะ</th>
                                        <th>QR Code</th>
                                        <th>จัดการ</th>
                                    </tr>
                                </thead>
                                <tbody id="qrCodesTable">
                                    <tr>
                                        <td colspan="7" class="loading">
                                            <div class="spinner"></div>
                                            กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

           
            <div id="transactions" class="page">
                <div class="card">
                    <div class="card-header">
                        <h6>ประวัติรายการทั้งหมด</h6>
                        <button class="btn btn-success" onclick="downloadTransactionsCSV()">
                            <i class="fas fa-download"></i> ดาวน์โหลด CSV
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ผู้ใช้</th>
                                        <th>รายการ</th>
                                        <th>แต้ม</th>
                                        <th class="mobile-hidden">วันที่</th>
                                    </tr>
                                </thead>
                                <tbody id="transactionsTable">
                                    <tr>
                                        <td colspan="4" class="loading">
                                            <div class="spinner"></div>
                                            กำลังโหลดข้อมูล...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

           
            <div id="analytics" class="page">
                <div class="download-section">
                    <h6><i class="fas fa-download"></i> ดาวน์โหลดข้อมูล</h6>
                    <div class="download-options">
                        <button class="btn btn-success" onclick="downloadUsersCSV()">
                            <i class="fas fa-users"></i> ข้อมูลผู้ใช้ (CSV)
                        </button>
                        <button class="btn btn-info" onclick="downloadRewardsCSV()">
                            <i class="fas fa-gift"></i> ข้อมูลรางวัล (CSV)
                        </button>
                        <button class="btn btn-warning" onclick="downloadQRCodesCSV()">
                            <i class="fas fa-qrcode"></i> ข้อมูล QR Code (CSV)
                        </button>
                        <button class="btn btn-primary" onclick="downloadRedemptionsCSV()">
                            <i class="fas fa-trophy"></i> ข้อมูลการแลกรางวัล (CSV)
                        </button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-header">
                                <h6>กราฟผู้ใช้งานรายเดือน</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="monthlyUsersChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>รางวัลยอดนิยม</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="popularRewardsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="card">
                            <div class="card-header">
                                <h6>การใช้งาน QR Code</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="qrUsageChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

   
    <div id="addPointsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>เพิ่มแต้มให้ผู้ใช้</h5>
                <button class="modal-close" onclick="closeModal('addPointsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="selectedUserInfo"
                    style="display: none; background-color: var(--light); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h6>ข้อมูลผู้ใช้ที่เลือก:</h6>
                    <div id="userInfoDisplay"></div>
                </div>
                <div class="form-group">
                    <label class="form-label">เลือกผู้ใช้</label>
                    <select class="form-control" id="modalSelectedUserId">
                        <option value="">-- เลือกผู้ใช้ --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">จำนวนแต้ม</label>
                    <input type="number" class="form-control" id="pointsAmount" placeholder="ใส่จำนวนแต้ม">
                </div>
                <div class="form-group">
                    <label class="form-label">คำอธิบาย</label>
                    <input type="text" class="form-control" id="pointsDescription" placeholder="เช่น เพิ่มแต้มโบนัส">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('addPointsModal')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="addManualPoints()">เพิ่มแต้ม</button>
            </div>
        </div>
    </div>

   
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="rewardModalTitle">เพิ่มรางวัล</h5>
                <button class="modal-close" onclick="closeModal('rewardModal')">&times;</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="rewardId">
                <div class="form-group">
                    <label class="form-label">ชื่อรางวัล</label>
                    <input type="text" class="form-control" id="rewardTitle" placeholder="ใส่ชื่อรางวัล">
                </div>
                <div class="form-group">
                    <label class="form-label">คำอธิบาย</label>
                    <textarea class="form-control" id="rewardDescription" rows="3"
                        placeholder="ใส่คำอธิบายรางวัล"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">แต้มที่ต้องใช้</label>
                    <input type="number" class="form-control" id="rewardPoints" placeholder="จำนวนแต้มที่ต้องใช้">
                </div>
                <div class="form-group">
                    <label class="form-label">จำนวนสต็อก (-1 = ไม่จำกัด)</label>
                    <input type="number" class="form-control" id="rewardStock" value="-1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('rewardModal')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="saveReward()">บันทึก</button>
            </div>
        </div>
    </div>

   
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>สร้าง QR Code</h5>
                <button class="modal-close" onclick="closeModal('qrModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">จำนวนแต้ม</label>
                    <input type="number" class="form-control" id="qrPoints" placeholder="จำนวนแต้มที่จะได้รับ">
                </div>
                <div class="form-group">
                    <label class="form-label">คำอธิบาย</label>
                    <input type="text" class="form-control" id="qrDescription" placeholder="เช่น สั่งอาหาร 100 บาท">
                </div>
                <div class="form-group">
                    <label class="form-label">วันที่หมดอายุ</label>
                    <input type="datetime-local" class="form-control" id="qrExpiry">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('qrModal')">ยกเลิก</button>
                <button class="btn btn-primary" onclick="generateQRCode()">สร้าง QR Code</button>
            </div>
        </div>
    </div>

    
    <div id="qrDisplayModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h5>QR Code</h5>
                <button class="modal-close" onclick="closeModal('qrDisplayModal')">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center;">
                <img id="qrCodeImage" src="" alt="QR Code" style="max-width: 100%; height: auto;">
                <p style="margin-top: 15px; font-weight: bold;" id="qrCodeText"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="downloadQRCode()">ดาวน์โหลด</button>
                <button class="btn btn-secondary" onclick="closeModal('qrDisplayModal')">ปิด</button>
            </div>
        </div>
    </div>

    <script>
       
        const API_URL = "https://script.google.com/macros/s/AKfycbzE1V9jXTeO-5b7vhu0R0IYA1QzvWK6VKoONw81FuazTibX1--PE2wnjWOlcq7rDhI2nA/exec";
        const LIFF_ID = "2007650567-LX0yGrNJ";
        const botBasicId = "@132jxygf"
        let currentEditingReward = null;
        let dashboardData = {};
        let qrScanner = null;
        let isScanning = false;
        const Toast = Swal.mixin({
            toast: true,
            position: "top-end",
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.onmouseenter = Swal.stopTimer;
                toast.onmouseleave = Swal.resumeTimer;
            }
        });

       
        document.addEventListener("DOMContentLoaded", function () {
            initializeLiff();
            loadDashboard();
            setDefaultExpiryDate();
        });

        function initializeLiff() {
            if (typeof liff !== 'undefined') {
                liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true }).then(() => {
                    if (liff.isLoggedIn()) {
                        liff.getProfile()
                            .then((profile) => {
                                const name = profile.displayName;
                                document.getElementById('admin-username').innerHTML = name
                            })
                            .catch((err) => {
                                console.log("error", err);
                            });

                        liff.getFriendship().then((data) => {
                            if (!data.friendFlag) {
                                Swal.fire('เดี๋ยวก่อน!', 'คุณยังไม่ได้เป็นเพื่อนกับเรา', 'error').then(() => {
                                    window.location = 'https://line.me/R/ti/p/' + botBasicId
                                })
                            }
                        });



                    } else {

                        if (liff.isInClient()) {
                            liff.login({ redirectUri: destinationUrl });
                        } else {
                            console.warn("LIFF is not in LINE client.");


                        }
                    }
                }).catch(err => {
                    console.error('LIFF initialization failed', err);


                });
            } else {
                console.log('LIFF SDK not found');


            }
        }

        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        }

      
        function showPage(pageId) {
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });

           
            document.getElementById(pageId).classList.add('active');

           
            event.target.classList.add('active');

            
            const titles = {
                'dashboard': 'Dashboard',
                'users': 'จัดการผู้ใช้',
                'rewards': 'จัดการรางวัล',
                'qrcodes': 'จัดการ QR Code',
                'transactions': 'ประวัติรายการ',
                'analytics': 'วิเคราะห์ข้อมูล'

            };
            document.getElementById('pageTitle').textContent = titles[pageId];

       
            if (pageId !== 'users' && isScanning) {
                stopQRScanner();
            }

            
            switch (pageId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'rewards':
                    loadRewards();
                    break;
                case 'qrcodes':
                    loadQRCodes();
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'analytics':
                    loadAnalytics();
                    break;

            }

            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }

        
        function switchSearchMethod(method) {
            document.querySelectorAll('.search-method').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.search-content').forEach(el => el.style.display = 'none');

            if (method === 'manual') {
                event.target.closest('.search-method').classList.add('active');
                document.getElementById('manualSearch').style.display = 'block';
                if (isScanning) stopQRScanner();
            } else if (method === 'qr') {
                event.target.closest('.search-method').classList.add('active');
                document.getElementById('qrSearch').style.display = 'block';
            }
        }

       
        function startQRScanner() {
            const qrReader = document.getElementById('qr-reader');

            if (!qrScanner) {
                qrScanner = new Html5Qrcode("qr-reader");
            }

            if (isScanning) {
                stopQRScanner();
                return;
            }

            const config = {
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0
            };

            qrScanner.start(
                { facingMode: "environment" },
                config,
                (decodedText, decodedResult) => {
                   
                    onQRScanSuccess(decodedText);
                },
                (errorMessage) => {
                    
                }
            ).then(() => {
                isScanning = true;
                document.querySelector('[onclick="startQRScanner()"]').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'inline-block';
            }).catch(err => {
                console.error("Unable to start scanner:", err);
                alert("ไม่สามารถเปิดกล้องได้ กรุณาตรวจสอบการอนุญาตใช้กล้อง");
            });
        }

        function stopQRScanner() {
            if (qrScanner && isScanning) {
                qrScanner.stop().then(() => {
                    isScanning = false;
                    document.querySelector('[onclick="startQRScanner()"]').style.display = 'inline-block';
                    document.getElementById('stopScanBtn').style.display = 'none';
                }).catch(err => {
                    console.error("Error stopping scanner:", err);
                });
            }
        }

        function onQRScanSuccess(decodedText) {
            
            stopQRScanner();

           
            document.getElementById('selectedUserId').value = decodedText;
            openAddPointsModal();
        }

       
        function loadDashboard() {
            Promise.all([
                callAPI('getUsers'),
                callAPI('getTransactions'),
                callAPI('getRedemptions'),
                callAPI('getQRCodes')
            ]).then(([usersResult, transactionsResult, redemptionsResult, qrCodesResult]) => {
                if (usersResult.success) {
                    document.getElementById('totalUsers').textContent = usersResult.users.length.toLocaleString();
                    dashboardData.users = usersResult.users;
                }

                if (transactionsResult.success) {
                    const totalPoints = transactionsResult.transactions
                        .filter(t => t.points > 0)
                        .reduce((sum, t) => sum + t.points, 0);
                    document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
                    dashboardData.transactions = transactionsResult.transactions;
                    displayRecentTransactions(transactionsResult.transactions.slice(0, 10));
                    createPointsChart(transactionsResult.transactions);
                }

                if (redemptionsResult.success) {
                    document.getElementById('totalRedemptions').textContent = redemptionsResult.redemptions.length.toLocaleString();
                    dashboardData.redemptions = redemptionsResult.redemptions;
                    createRedemptionsChart(redemptionsResult.redemptions);
                }

                if (qrCodesResult.success) {
                    const activeQRs = qrCodesResult.qrCodes.filter(qr => !qr.isUsed && new Date(qr.expiryDate) > new Date());
                    document.getElementById('activeQRCodes').textContent = activeQRs.length.toLocaleString();
                    dashboardData.qrCodes = qrCodesResult.qrCodes;
                }
            });
        }

       
        function displayRecentTransactions(transactions) {
            const tbody = document.getElementById('recentTransactions');
            tbody.innerHTML = '';

            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
                return;
            }

            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                const date = new Date(transaction.timestamp);
                const shortDate = formatDate(`${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`)
                const formattedDate = `${shortDate} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}  น.`;

                row.innerHTML = `
                    <td>${transaction.displayName || 'ไม่ทราบชื่อ'}</td>
                    <td>${transaction.description}</td>
                    <td class="${transaction.points > 0 ? 'text-success' : 'text-danger'}">
                        ${transaction.points > 0 ? '+' : ''}${transaction.points.toLocaleString()}
                    </td>
                    <td class="mobile-hidden">${formattedDate}</td>
                `;
                tbody.appendChild(row);
            });
        }


        function createPointsChart(transactions) {
            const ctx = document.getElementById('pointsChart').getContext('2d');

          
            const dailyPoints = {};
            transactions.filter(t => t.points > 0).forEach(transaction => {
                const date = new Date(transaction.timestamp).toDateString();
                dailyPoints[date] = (dailyPoints[date] || 0) + transaction.points;
            });

            // ดึงแค่ 7 วันเพื่อความสวยงาม
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toDateString());
            }

            const chartData = last7Days.map(date => dailyPoints[date] || 0);
            const chartLabels = last7Days.map(date => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'แต้มที่แจก',
                        data: chartData,
                        borderColor: '#1ea896',
                        backgroundColor: 'rgba(30, 168, 150, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

       
        function createRedemptionsChart(redemptions) {
            const ctx = document.getElementById('redemptionsChart').getContext('2d');

           
            const dailyRedemptions = {};
            redemptions.forEach(redemption => {
                const date = new Date(redemption.redeemedAt).toDateString();
                dailyRedemptions[date] = (dailyRedemptions[date] || 0) + 1;
            });

            // ดึงแค่ 7 วันเพื่อความสวยงาม
            const last7Days = [];
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                last7Days.push(date.toDateString());
            }

            const chartData = last7Days.map(date => dailyRedemptions[date] || 0);
            const chartLabels = last7Days.map(date => {
                const d = new Date(date);
                return `${d.getDate()}/${d.getMonth() + 1}`;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'การแลกรางวัล',
                        data: chartData,
                        backgroundColor: '#ff715b'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

       
        function loadUsers() {
            callAPI('getUsers').then(result => {
                const tbody = document.getElementById('usersTable');
                tbody.innerHTML = '';

                if (!result.success || result.users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
                    return;
                }

               
                const userSelects = ['selectedUserId', 'modalSelectedUserId'];
                userSelects.forEach(selectId => {
                    const userSelect = document.getElementById(selectId);
                    userSelect.innerHTML = '<option value="">-- เลือกผู้ใช้ --</option>';

                    result.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.userId;
                        option.textContent = `${user.displayName} (${user.points} แต้ม)`;
                        userSelect.appendChild(option);
                    });
                });

                result.users.forEach(user => {
                    const row = document.createElement('tr');
                    const createdDate = new Date(user.createdAt);
                    const formattedDate = formatDate(`${createdDate.getMonth() + 1}/${createdDate.getDate()}/${createdDate.getFullYear()}`);

                    row.innerHTML = `
                        <td>${user.displayName}</td>
                        <td>${user.points.toLocaleString()}</td>
                        <td class="mobile-hidden">${user.level}</td>
                        <td class="mobile-hidden">${formattedDate}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editUserPoints('${user.userId}', '${user.displayName}')">
                                เพิ่มแต้ม
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function refreshUsers() {
            loadUsers();
        }

       
        function loadRewards() {
            callAPI('getRewards').then(result => {
                const tbody = document.getElementById('rewardsTable');
                tbody.innerHTML = '';

                if (!result.success || result.rewards.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
                    return;
                }

                result.rewards.forEach(reward => {
                    const row = document.createElement('tr');
                    const stockText = reward.stock === -1 ? 'ไม่จำกัด' : reward.stock.toLocaleString();

                    row.innerHTML = `
                        <td>${reward.title}</td>
                        <td class="mobile-hidden">${reward.description}</td>
                        <td>${reward.pointsRequired.toLocaleString()}</td>
                        <td class="mobile-hidden">${stockText}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editReward('${reward.id}')">แก้ไข</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteReward('${reward.id}')">ลบ</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

     
        function loadQRCodes() {
            callAPI('getQRCodes').then(result => {
                const tbody = document.getElementById('qrCodesTable');
                tbody.innerHTML = '';

                if (!result.success || result.qrCodes.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
                    return;
                }

                result.qrCodes.forEach(qr => {
                    const row = document.createElement('tr');
                    const expiryDate = new Date(qr.expiryDate);
                    const formattedExpiry = formatDate(`${expiryDate.getMonth() + 1}/${expiryDate.getDate()}/${expiryDate.getFullYear()}`);
                    const isExpired = expiryDate < new Date();
                    const statusClass = qr.isUsed ? 'badge-danger' : (isExpired ? 'badge-warning' : 'badge-success');
                    const statusText = qr.isUsed ? 'ใช้แล้ว' : (isExpired ? 'หมดอายุ' : 'ใช้ได้');

                    row.innerHTML = `
                        <td>${qr.code}</td>
                        <td>${qr.points.toLocaleString()}</td>
                        <td class="mobile-hidden">${qr.description}</td>
                        <td class="mobile-hidden">${formattedExpiry}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-secondary" onclick="showQRCode('${qr.code}')">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="deleteQRCode('${qr.code}')">ลบ</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        
        function loadTransactions() {
            callAPI('getTransactions').then(result => {
                const tbody = document.getElementById('transactionsTable');
                tbody.innerHTML = '';

                if (!result.success || result.transactions.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">ไม่มีข้อมูล</td></tr>';
                    return;
                }

                
                const sortedTransactions = result.transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                sortedTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    const date = new Date(transaction.timestamp);
                    const shortDate = formatDate(`${date.getMonth() + 1}/${date.getDate()}/${date.getFullYear()}`)
                    const formattedDate = `${shortDate} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')} น.`;

                    row.innerHTML = `
                        <td>${transaction.displayName || 'ไม่ทราบชื่อ'}</td>
                        <td>${transaction.description}</td>
                        <td class="${transaction.points > 0 ? 'text-success' : 'text-danger'}">
                            ${transaction.points > 0 ? '+' : ''}${transaction.points.toLocaleString()}
                        </td>
                        <td class="mobile-hidden">${formattedDate}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

       
        function loadAnalytics() {
            Promise.all([
                callAPI('getUsers'),
                callAPI('getRedemptions'),
                callAPI('getQRCodes')
            ]).then(([usersResult, redemptionsResult, qrCodesResult]) => {
                if (usersResult.success) {
                    createMonthlyUsersChart(usersResult.users);
                }

                if (redemptionsResult.success) {
                    createPopularRewardsChart(redemptionsResult.redemptions);
                }

                if (qrCodesResult.success) {
                    createQRUsageChart(qrCodesResult.qrCodes);
                }
            });
        }

      
        function createMonthlyUsersChart(users) {
            const ctx = document.getElementById('monthlyUsersChart').getContext('2d');

          
            const monthlyUsers = {};
            users.forEach(user => {
                const date = new Date(user.createdAt);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyUsers[monthKey] = (monthlyUsers[monthKey] || 0) + 1;
            });

            // แสดงผลแค่ 6 เดือน
            const last6Months = [];
            const today = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                last6Months.push(`${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`);
            }

            const chartData = last6Months.map(month => monthlyUsers[month] || 0);
            const chartLabels = last6Months.map(month => {
                const [year, monthNum] = month.split('-');
                const monthNames = ['ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.', 'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'];
                return `${monthNames[parseInt(monthNum) - 1]} ${year}`;
            });

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: 'ผู้ใช้ใหม่',
                        data: chartData,
                        borderColor: '#1ea896',
                        backgroundColor: 'rgba(30, 168, 150, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

     
        function createPopularRewardsChart(redemptions) {
            const ctx = document.getElementById('popularRewardsChart').getContext('2d');

          
            const rewardCounts = {};
            redemptions.forEach(redemption => {
                const rewardTitle = redemption.rewardTitle || 'ไม่ทราบ';
                rewardCounts[rewardTitle] = (rewardCounts[rewardTitle] || 0) + 1;
            });

            // ดึงแค่ 5 อันดับแรก ที่นิยมแลก rewards
            const sortedRewards = Object.entries(rewardCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const chartLabels = sortedRewards.map(([title]) => title);
            const chartData = sortedRewards.map(([, count]) => count);

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: [
                            '#1ea896',
                            '#ff715b',
                            '#28a745',
                            '#ffc107',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        
        function createQRUsageChart(qrCodes) {
            const ctx = document.getElementById('qrUsageChart').getContext('2d');

            const usedCount = qrCodes.filter(qr => qr.isUsed).length;
            const expiredCount = qrCodes.filter(qr => !qr.isUsed && new Date(qr.expiryDate) < new Date()).length;
            const activeCount = qrCodes.filter(qr => !qr.isUsed && new Date(qr.expiryDate) >= new Date()).length;

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['ใช้แล้ว', 'หมดอายุ', 'ใช้ได้'],
                    datasets: [{
                        data: [usedCount, expiredCount, activeCount],
                        backgroundColor: ['#dc3545', '#ffc107', '#28a745']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }



        // CSV Download functions
        function downloadCSV(data, filename) {
            const csv = arrayToCSV(data);
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function arrayToCSV(data) {
            if (!data || data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            // Add headers
            csvRows.push(headers.join(','));

            // Add data rows
            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header];
                    // Escape quotes and wrap in quotes if contains comma
                    return typeof value === 'string' && (value.includes(',') || value.includes('"'))
                        ? `"${value.replace(/"/g, '""')}"`
                        : value;
                });
                csvRows.push(values.join(','));
            }

            return csvRows.join('\n');
        }

        function downloadUsersCSV() {
            callAPI('getUsers').then(result => {
                if (result.success) {
                    const data = result.users.map(user => ({
                        'User ID': user.userId,
                        'Display Name': user.displayName,
                        'Points': user.points,
                        'Level': user.level,
                        'Created At': new Date(user.createdAt).toLocaleString('th-TH')
                    }));
                    downloadCSV(data, `users_${new Date().toISOString().split('T')[0]}.csv`);
                }
            });
        }

        function downloadRewardsCSV() {
            callAPI('getRewards').then(result => {
                if (result.success) {
                    const data = result.rewards.map(reward => ({
                        'ID': reward.id,
                        'Title': reward.title,
                        'Description': reward.description,
                        'Points Required': reward.pointsRequired,
                        'Stock': reward.stock
                    }));
                    downloadCSV(data, `rewards_${new Date().toISOString().split('T')[0]}.csv`);
                }
            });
        }

        function downloadQRCodesCSV() {
            callAPI('getQRCodes').then(result => {
                if (result.success) {
                    const data = result.qrCodes.map(qr => ({
                        'Code': qr.code,
                        'Points': qr.points,
                        'Description': qr.description,
                        'Expiry Date': new Date(qr.expiryDate).toLocaleString('th-TH'),
                        'Is Used': qr.isUsed ? 'ใช้แล้ว' : 'ยังไม่ได้ใช้',
                        'Created At': new Date(qr.createdAt).toLocaleString('th-TH')
                    }));
                    downloadCSV(data, `qrcodes_${new Date().toISOString().split('T')[0]}.csv`);
                }
            });
        }

        function downloadRedemptionsCSV() {
            callAPI('getRedemptions').then(result => {
                if (result.success) {
                    const data = result.redemptions.map(redemption => ({
                        'ID': redemption.id,
                        'User': redemption.displayName,
                        'Reward': redemption.rewardTitle,
                        'Redemption Code': redemption.redemptionCode,
                        'Status': redemption.status,
                        'Redeemed At': new Date(redemption.redeemedAt).toLocaleString('th-TH')
                    }));
                    downloadCSV(data, `redemptions_${new Date().toISOString().split('T')[0]}.csv`);
                }
            });
        }

        function downloadTransactionsCSV() {
            callAPI('getTransactions').then(result => {
                if (result.success) {
                    const data = result.transactions.map(transaction => ({
                        'ID': transaction.id,
                        'User': transaction.displayName,
                        'Points': transaction.points,
                        'Description': transaction.description,
                        'Timestamp': new Date(transaction.timestamp).toLocaleString('th-TH')
                    }));
                    downloadCSV(data, `transactions_${new Date().toISOString().split('T')[0]}.csv`);
                }
            });
        }


        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

       
        function openAddPointsModal() {
            const selectedUserId = document.getElementById('selectedUserId').value;
            if (selectedUserId) {
                document.getElementById('modalSelectedUserId').value = selectedUserId;
                updateSelectedUserInfo(selectedUserId);
            }
            openModal('addPointsModal');
        }

        function editUserPoints(userId, displayName) {
            document.getElementById('modalSelectedUserId').value = userId;
            updateSelectedUserInfo(userId);
            openModal('addPointsModal');
        }

        function updateSelectedUserInfo(userId) {
            if (!userId) {
                document.getElementById('selectedUserInfo').style.display = 'none';
                return;
            }

            const userSelect = document.getElementById('modalSelectedUserId');
            const selectedOption = userSelect.options[userSelect.selectedIndex];
            if (selectedOption && selectedOption.value) {
                document.getElementById('selectedUserInfo').style.display = 'block';
                document.getElementById('userInfoDisplay').innerHTML = `
                    <strong>${selectedOption.textContent}</strong>
                `;
            }
        }

       
        function addManualPoints() {
            const userId = document.getElementById('modalSelectedUserId').value;
            const points = document.getElementById('pointsAmount').value;
            const description = document.getElementById('pointsDescription').value;

            if (!userId || !points) {
                Toast.fire({
                    icon: "warning",
                    title: "กรุณากรอกข้อมูลให้ครบถ้วน"
                });

                return;
            }
            closeModal('addPointsModal');
            Swal.fire({
                title: "กำลังโหลด..",
                text: "โปรดรอสักครู่",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            callAPI('addManualPoints', {
                userId: userId,
                points: points,
                description: description
            }).then(result => {
                if (result.success) {
                    Toast.fire({
                        icon: "success",
                        title: result.message
                    });
                   
                    closeModal('addPointsModal');
                    loadUsers();
                    loadDashboard();

                    document.getElementById('modalSelectedUserId').value = '';
                    document.getElementById('pointsAmount').value = '';
                    document.getElementById('pointsDescription').value = '';
                    document.getElementById('selectedUserInfo').style.display = 'none';
                } else {
                    Toast.fire({
                        icon: "error",
                        title: 'เกิดข้อผิดพลาด: ' + result.message
                    });
                    
                }
            });
        }


        function openRewardModal() {
            currentEditingReward = null;
            document.getElementById('rewardModalTitle').textContent = 'เพิ่มรางวัล';
            document.getElementById('rewardId').value = '';
            document.getElementById('rewardTitle').value = '';
            document.getElementById('rewardDescription').value = '';
            document.getElementById('rewardPoints').value = '';
            document.getElementById('rewardStock').value = '-1';
            openModal('rewardModal');
        }

        function editReward(rewardId) {
            callAPI('getRewards').then(result => {
                if (result.success) {
                    const reward = result.rewards.find(r => r.id === rewardId);
                    if (reward) {
                        currentEditingReward = reward;
                        document.getElementById('rewardModalTitle').textContent = 'แก้ไขรางวัล';
                        document.getElementById('rewardId').value = reward.id;
                        document.getElementById('rewardTitle').value = reward.title;
                        document.getElementById('rewardDescription').value = reward.description;
                        document.getElementById('rewardPoints').value = reward.pointsRequired;
                        document.getElementById('rewardStock').value = reward.stock;
                        openModal('rewardModal');
                    }
                }
            });
        }

        function saveReward() {
            const id = document.getElementById('rewardId').value;
            const title = document.getElementById('rewardTitle').value;
            const description = document.getElementById('rewardDescription').value;
            const points = document.getElementById('rewardPoints').value;
            const stock = document.getElementById('rewardStock').value;

            if (!title || !description || !points) {
                Toast.fire({
                    icon: "warning",
                    title: "กรุณากรอกข้อมูลให้ครบถ้วน"
                });
              
                return;
            }

            closeModal('rewardModal');
            Swal.fire({
                title: "กำลังโหลด..",
                text: "โปรดรอสักครู่",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const action = id ? 'updateReward' : 'addReward';
            const params = {
                title: title,
                description: description,
                pointsRequired: points,
                stock: stock
            };

            if (id) {
                params.id = id;
            }

            callAPI(action, params).then(result => {
                if (result.success) {
                    Toast.fire({
                        icon: "success",
                        title: result.message
                    });
                   
                    closeModal('rewardModal');
                    loadRewards();
                } else {
                    Toast.fire({
                        icon: "error",
                        title: 'เกิดข้อผิดพลาด: ' + result.message
                    });
                   
                }
            });
        }

        function deleteReward(rewardId) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบรางวัลนี้?')) {
                Swal.fire({
                    title: "กำลังโหลด..",
                    text: "โปรดรอสักครู่",
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                callAPI('deleteReward', { id: rewardId }).then(result => {
                    if (result.success) {
                        Toast.fire({
                            icon: "success",
                            title: result.message
                        });
                        
                        loadRewards();
                    } else {
                        Toast.fire({
                            icon: "error",
                            title: 'เกิดข้อผิดพลาด: ' + result.message
                        });
                       
                    }
                });
            }
        }

        
        function openQRModal() {
            openModal('qrModal');
        }

        function generateQRCode() {
            const points = document.getElementById('qrPoints').value;
            const description = document.getElementById('qrDescription').value;
            const expiry = document.getElementById('qrExpiry').value;

            if (!points || !description || !expiry) {
                Toast.fire({
                    icon: "warning",
                    title: "กรุณากรอกข้อมูลให้ครบถ้วน"
                });
                
                return;
            }
            closeModal('qrModal');
            Swal.fire({
                title: "กำลังโหลด..",
                text: "โปรดรอสักครู่",
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            callAPI('generateQRCode', {
                points: points,
                description: description,
                expiryDate: expiry
            }).then(result => {
                if (result.success) {
                    Toast.fire({
                        icon: "success",
                        title: `สร้าง QR Code สำเร็จ\nโค้ด: ${result.code}`
                    });
                   
                    closeModal('qrModal');
                    loadQRCodes();

                    
                    showQRCode(result.code);

                    
                    document.getElementById('qrPoints').value = '';
                    document.getElementById('qrDescription').value = '';
                    document.getElementById('qrExpiry').value = '';
                } else {
                    Toast.fire({
                        icon: "error",
                        title: 'เกิดข้อผิดพลาด: ' + result.message
                    });
                    
                }
            });
        }

        function showQRCode(code) {
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?data=${encodeURIComponent(code)}&size=300x300`;
            document.getElementById('qrCodeImage').src = qrUrl;
            document.getElementById('qrCodeText').textContent = `โค้ด: ${code}`;
            openModal('qrDisplayModal');
        }

        function downloadQRCode() {
            const img = document.getElementById('qrCodeImage');
            const link = document.createElement('a');
            link.download = `qr-code-${document.getElementById('qrCodeText').textContent.replace('โค้ด: ', '')}.png`;
            link.href = img.src;
            link.click();
        }

        function deleteQRCode(code) {
            if (confirm('คุณแน่ใจหรือไม่ที่จะลบ QR Code นี้?')) {
                Swal.fire({
                    title: "กำลังโหลด..",
                    text: "โปรดรอสักครู่",
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                callAPI('deleteQRCode', { code: code }).then(result => {
                    if (result.success) {
                        Toast.fire({
                            icon: "success",
                            title: result.message
                        });
                       
                        loadQRCodes();
                    } else {
                        Toast.fire({
                            icon: "error",
                            title: 'เกิดข้อผิดพลาด: ' + result.message
                        });
                        
                    }
                });
            }
        }



       
        function setDefaultExpiryDate() {
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            tomorrow.setHours(23, 59, 0, 0);
            document.getElementById('qrExpiry').value = tomorrow.toISOString().slice(0, 16);
        }

        
        function callAPI(action, params = {}) {
            const formData = new URLSearchParams();
            formData.append("action", action);

            Object.keys(params).forEach(key => {
                formData.append(key, params[key]);
            });

            return fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: formData
            })
                .then(response => response.json())
                .catch(error => {
                    console.error("API Error:", error);
                    return { success: false, message: "Network error" };
                });
        }

        
        window.addEventListener('resize', function () {
            if (window.innerWidth > 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        });

       
        document.addEventListener('DOMContentLoaded', function () {
            const modalUserSelect = document.getElementById('modalSelectedUserId');
            if (modalUserSelect) {
                modalUserSelect.addEventListener('change', function () {
                    updateSelectedUserInfo(this.value);
                });
            }
        });

        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return dateString;
                }
                return date.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'

                });
            } catch (e) {
                console.error("Error formatting date:", dateString, e);
                return dateString;
            }
        }
    </script>
</body>

</html>
